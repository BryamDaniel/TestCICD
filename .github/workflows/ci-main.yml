name: Integracion Continua (CI)

# Define cuándo se ejecutará este flujo de trabajo
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# Define el conjunto de tareas (jobs) a ejecutar
jobs:
  build-and-test:
    name: Build & Test (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: ['20.x'] # Usa la versión LTS de Node.js, ajústala si es necesario

    steps:
      # 1. Checkout: Baja tu código del repositorio
      - name: Checkout del Repositorio
        uses: actions/checkout@v4

      # 2. Setup Node: Configura el entorno de Node
      - name: Configurar Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          # Usar cache para dependencias, esto acelera el proceso
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json' 

      # --- TAREAS DEL SERVER (Node/Express/TS) ---

      # 3. Server: Instalar dependencias
      - name: Server - Instalar Dependencias
        run: npm install
        working-directory: ./server # ¡Cambio aquí!


      - name: Lint Code
        run: npm run lint
        working-directory: ./server # ¡Cambio aquí!

      - name: Type Check
        run: npm run tsc -- --noEmit
        working-directory: ./server # ¡Cambio aquí!
        
      # 4. Server: Construir (Compilar TypeScript)
      - name: Server - Construir (npm run build)
        run: npm run build
        working-directory: ./server # ¡Cambio aquí!
        
      # 5. Server: Ejecutar Tests
      - name: Server - Ejecutar Tests (npm test)
        run: npm test
        working-directory: ./server # ¡Cambio aquí!

      # --- TAREAS DEL CLIENT (React/Vite/TS) ---

      # 6. Client: Instalar dependencias
      - name: Client - Instalar Dependencias
        run: npm install
        working-directory: ./client # ¡Cambio aquí!

      - name: Lint Code
        run: npm run lint
        working-directory: ./client # ¡Cambio aquí!

      - name: Type Check
        run: npm run tsc -- --noEmit
        working-directory: ./client # ¡Cambio aquí!
        
      # 7. Client: Construir (Generar la versión de producción con Vite)
      - name: Client - Construir (npm run build)
        run: npm run build
        working-directory: ./client # ¡Cambio aquí!
        
      # 8. Client: Ejecutar Tests
      - name: Client - Ejecutar Tests (npm test)
        run: npm test
        working-directory: ./client # ¡Cambio aquí!